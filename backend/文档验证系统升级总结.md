# æ–‡æ¡£éªŒè¯ç³»ç»Ÿå‡çº§æ€»ç»“

## æ¦‚è¿°

æ ¹æ®æä¾›çš„æ–‡æ¡£éªŒè¯æ¨¡æ¿æŒ‡å—ï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸå‡çº§äº†åç«¯çš„æ–‡æ¡£æ ¡éªŒç³»ç»Ÿï¼Œä»åŸæ¥çš„ç®€å•å­—å…¸æ ¼å¼å‡çº§ä¸ºåŸºäºPydanticçš„AnnotationSchemaæ ¼å¼ã€‚

## ä¸»è¦æ”¹è¿›

### 1. æ–°çš„æ¨¡æ¿æ ¼å¼

**æ—§æ ¼å¼ï¼ˆå·²åºŸå¼ƒï¼‰ï¼š**
```python
TEMPLATE_INFO = {
    "name": "æ–‡æ¡£æ ‡æ³¨æ¨¡æ¿",
    "version": "1.0.0",
    "description": "ç”¨äºæ–‡æ¡£æ ‡æ³¨çš„ç¤ºä¾‹æ¨¡æ¿"
}

ANNOTATION_FIELDS = [
    {
        "name": "title",
        "type": "string",
        "required": True,
        "description": "æ–‡æ¡£æ ‡é¢˜"
    }
]
```

**æ–°æ ¼å¼ï¼ˆAnnotationSchemaï¼‰ï¼š**
```python
from typing import List, Dict, Any, Optional
from pydantic import BaseModel, Field
from enum import Enum

class AnnotationSchema:
    schema_name = "æ–‡æ¡£æ ‡æ³¨ç¤ºä¾‹æ¨¡æ¿"
    version = "1.0.0"
    description = "è¿™æ˜¯ä¸€ä¸ªç”¨äºæ–‡æ¡£æ ‡æ³¨çš„ç¤ºä¾‹æ¨¡æ¿"
    
    class Fields(BaseModel):
        title: str = Field(
            description="æ–‡æ¡£æ ‡é¢˜",
            min_length=1,
            max_length=200,
            example="ç¤ºä¾‹æ–‡æ¡£æ ‡é¢˜"
        )
    
    fields = Fields
```

### 2. æ ¸å¿ƒç»„ä»¶

#### 2.1 æ¨¡æ¿éªŒè¯å™¨ (`TemplateValidator`)
- **ä½ç½®**: `backend/app/core/template_validator.py`
- **åŠŸèƒ½**: éªŒè¯æ¨¡æ¿æ–‡ä»¶æ˜¯å¦ç¬¦åˆAnnotationSchemaæ ¼å¼
- **ç‰¹æ€§**:
  - è¯­æ³•æ£€æŸ¥
  - ç»“æ„éªŒè¯
  - å­—æ®µå‘½åè§„èŒƒæ£€æŸ¥
  - UIæ§ä»¶é…ç½®éªŒè¯
  - åµŒå¥—å±‚çº§é™åˆ¶
  - å…¼å®¹Pydantic v1å’Œv2

#### 2.2 æ ‡æ³¨æ•°æ®éªŒè¯å™¨ (`AnnotationValidator`)
- **ä½ç½®**: `backend/app/core/annotation_validator.py`
- **åŠŸèƒ½**: éªŒè¯æ ‡æ³¨æ•°æ®æ˜¯å¦ç¬¦åˆæ¨¡æ¿å®šä¹‰
- **ç‰¹æ€§**:
  - å®Œæ•´æ•°æ®éªŒè¯
  - éƒ¨åˆ†æ•°æ®éªŒè¯ï¼ˆå®æ—¶éªŒè¯ï¼‰
  - è¯¦ç»†é”™è¯¯ä¿¡æ¯
  - æ¨¡æ¿ç¼“å­˜æœºåˆ¶

#### 2.3 å­˜å‚¨ç®¡ç†å™¨å‡çº§
- **ä½ç½®**: `backend/app/core/storage.py`
- **æ”¹è¿›**: é›†æˆæ–°çš„æ¨¡æ¿éªŒè¯å™¨
- **æ–¹æ³•**: `validate_python_template()` ä½¿ç”¨æ–°çš„éªŒè¯é€»è¾‘

### 3. APIæ¥å£

#### 3.1 æ–°å¢éªŒè¯æ¥å£
- `POST /api/annotations/validate` - éªŒè¯å®Œæ•´æ ‡æ³¨æ•°æ®
- `POST /api/annotations/validate-partial` - éªŒè¯éƒ¨åˆ†æ ‡æ³¨æ•°æ®

#### 3.2 æ ‡æ³¨ç®¡ç†æ¥å£
- `GET /api/annotations/{task_id}/{document_id}` - è·å–æ ‡æ³¨æ•°æ®
- `POST /api/annotations/{task_id}/{document_id}` - ä¿å­˜æ ‡æ³¨æ•°æ®ï¼ˆå¸¦éªŒè¯ï¼‰
- `PUT /api/annotations/{task_id}/{document_id}` - æ›´æ–°æ ‡æ³¨æ•°æ®ï¼ˆå¸¦éªŒè¯ï¼‰
- `DELETE /api/annotations/{task_id}/{document_id}` - åˆ é™¤æ ‡æ³¨æ•°æ®

### 4. æ•°æ®æ¨¡å‹æ›´æ–°

#### 4.1 æ ‡æ³¨æ¨¡å‹ (`Annotation`)
```python
class Annotation(BaseModel):
    document_id: str
    task_id: str
    status: AnnotationStatus = AnnotationStatus.PENDING
    annotator_id: Optional[str] = None
    annotation_data: Dict[str, Any] = {}  # ç»Ÿä¸€å­—æ®µå
    updated_at: datetime = None
```

#### 4.2 ä»»åŠ¡æ¨¡æ¿æ¨¡å‹ (`TaskTemplate`)
```python
class TaskTemplate(BaseModel):
    filename: str
    file_path: str
```

### 5. æ”¯æŒçš„å­—æ®µç±»å‹å’Œç‰¹æ€§

#### 5.1 åŸºæœ¬æ•°æ®ç±»å‹
- `str` - å­—ç¬¦ä¸²
- `int` - æ•´æ•°
- `float` - æµ®ç‚¹æ•°
- `bool` - å¸ƒå°”å€¼
- `List[T]` - åˆ—è¡¨
- `Dict[K, V]` - å­—å…¸
- `Optional[T]` - å¯é€‰ç±»å‹

#### 5.2 éªŒè¯çº¦æŸ
- `min_length/max_length` - å­—ç¬¦ä¸²é•¿åº¦é™åˆ¶
- `gt/ge/lt/le` - æ•°å€¼å¤§å°é™åˆ¶
- `regex` - æ­£åˆ™è¡¨è¾¾å¼éªŒè¯

#### 5.3 UIæ§ä»¶æ”¯æŒ
- `text` - å•è¡Œæ–‡æœ¬æ¡†
- `textarea` - å¤šè¡Œæ–‡æœ¬æ¡†
- `select` - ä¸‹æ‹‰é€‰æ‹©æ¡†
- `radio` - å•é€‰æŒ‰é’®ç»„
- `checkbox` - å¤é€‰æ¡†
- `date-picker` - æ—¥æœŸé€‰æ‹©å™¨
- `time-picker` - æ—¶é—´é€‰æ‹©å™¨
- `color-picker` - é¢œè‰²é€‰æ‹©å™¨
- `tag-input` - æ ‡ç­¾è¾“å…¥æ¡†
- `monaco-editor` - ä»£ç ç¼–è¾‘å™¨

#### 5.4 é«˜çº§ç‰¹æ€§
- åµŒå¥—æ¨¡å‹æ”¯æŒ
- æšä¸¾ç±»å‹æ”¯æŒ
- æ¡ä»¶æ˜¾ç¤ºï¼ˆ`depends_on`ï¼‰
- é€‰æ‹©é¡¹é…ç½®ï¼ˆ`choices`ï¼‰
- ç¤ºä¾‹å€¼ï¼ˆ`example`ï¼‰

### 6. ç¤ºä¾‹æ¨¡æ¿

å®Œæ•´çš„ç¤ºä¾‹æ¨¡æ¿ä½äºï¼š`backend/data/public_files/templates/example_template.py`

```python
from typing import List, Dict, Any, Optional, Union
from pydantic import BaseModel, Field
from enum import Enum

class DocumentType(str, Enum):
    ARTICLE = "article"
    REPORT = "report"
    CONTRACT = "contract"
    OTHER = "other"

class Author(BaseModel):
    name: str = Field(description="ä½œè€…å§“å", min_length=1, max_length=50)
    email: Optional[str] = Field(description="ä½œè€…é‚®ç®±", default=None)

class AnnotationSchema:
    schema_name = "æ–‡æ¡£æ ‡æ³¨ç¤ºä¾‹æ¨¡æ¿"
    version = "1.0.0"
    description = "è¿™æ˜¯ä¸€ä¸ªç”¨äºæ–‡æ¡£æ ‡æ³¨çš„ç¤ºä¾‹æ¨¡æ¿ï¼ŒåŒ…å«åŸºæœ¬å­—æ®µå’ŒåµŒå¥—ç»“æ„"
    
    class Fields(BaseModel):
        title: str = Field(
            description="æ–‡æ¡£æ ‡é¢˜",
            min_length=1,
            max_length=200,
            example="ç¤ºä¾‹æ–‡æ¡£æ ‡é¢˜"
        )
        
        doc_type: DocumentType = Field(
            description="æ–‡æ¡£ç±»å‹",
            example=DocumentType.ARTICLE
        )
        
        content: str = Field(
            description="æ–‡æ¡£å†…å®¹",
            min_length=1,
            example="è¿™æ˜¯æ–‡æ¡£çš„ä¸»è¦å†…å®¹...",
            json_schema_extra={"ui_widget": "textarea"}
        )
        
        authors: List[Author] = Field(
            description="ä½œè€…åˆ—è¡¨",
            default=[]
        )
        
        keywords: List[str] = Field(
            description="å…³é”®è¯åˆ—è¡¨",
            default=[],
            json_schema_extra={"ui_widget": "tag-input"}
        )
        
        importance: int = Field(
            description="é‡è¦æ€§è¯„åˆ†",
            ge=1,
            le=5,
            example=3
        )
        
        is_reviewed: bool = Field(
            description="æ˜¯å¦å·²å®¡æ ¸",
            default=False
        )
        
        metadata: Dict[str, Any] = Field(
            description="å…ƒæ•°æ®",
            default={}
        )
        
        notes: Optional[str] = Field(
            description="å¤‡æ³¨ä¿¡æ¯",
            default="",
            json_schema_extra={"ui_widget": "textarea"}
        )
    
    fields = Fields
```

### 7. æµ‹è¯•éªŒè¯

#### 7.1 æµ‹è¯•è„šæœ¬
- `test_template_validation.py` - åŸºç¡€æ¨¡æ¿éªŒè¯æµ‹è¯•
- `test_complete_validation.py` - å®Œæ•´ç³»ç»Ÿæµ‹è¯•

#### 7.2 æµ‹è¯•è¦†ç›–
- âœ… æ¨¡æ¿è¯­æ³•éªŒè¯
- âœ… æ¨¡æ¿ç»“æ„éªŒè¯
- âœ… å­—æ®µç±»å‹éªŒè¯
- âœ… æ•°æ®éªŒè¯ï¼ˆæœ‰æ•ˆ/æ— æ•ˆæ•°æ®ï¼‰
- âœ… éƒ¨åˆ†æ•°æ®éªŒè¯
- âœ… APIæ¨¡å‹å…¼å®¹æ€§
- âœ… å­˜å‚¨ç®¡ç†å™¨é›†æˆ
- âœ… ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•

### 8. å…¼å®¹æ€§

#### 8.1 Pydanticç‰ˆæœ¬å…¼å®¹
- æ”¯æŒPydantic v1.x
- æ”¯æŒPydantic v2.x
- è‡ªåŠ¨æ£€æµ‹ç‰ˆæœ¬å¹¶ä½¿ç”¨ç›¸åº”çš„API

#### 8.2 å‘åå…¼å®¹
- æ—§çš„æ¨¡æ¿æ ¼å¼ä»ç„¶å¯ä»¥é€šè¿‡è½¬æ¢å·¥å…·è¿ç§»
- APIæ¥å£ä¿æŒå‘åå…¼å®¹

### 9. æ€§èƒ½ä¼˜åŒ–

#### 9.1 ç¼“å­˜æœºåˆ¶
- æ¨¡æ¿è§£æç»“æœç¼“å­˜
- é¿å…é‡å¤åŠ è½½å’Œè§£æ

#### 9.2 é”™è¯¯å¤„ç†
- è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- å‹å¥½çš„é”™è¯¯æç¤º
- å¼‚å¸¸å®‰å…¨å¤„ç†

### 10. ä½¿ç”¨æŒ‡å—

#### 10.1 åˆ›å»ºæ–°æ¨¡æ¿
1. æŒ‰ç…§AnnotationSchemaæ ¼å¼åˆ›å»ºPythonæ–‡ä»¶
2. å®šä¹‰å¿…è¦çš„ç±»å’Œå­—æ®µ
3. ä¸Šä¼ åˆ°æ¨¡æ¿ç›®å½•
4. ç³»ç»Ÿè‡ªåŠ¨éªŒè¯æ¨¡æ¿æ ¼å¼

#### 10.2 ä½¿ç”¨æ¨¡æ¿è¿›è¡Œæ ‡æ³¨
1. åˆ›å»ºä»»åŠ¡æ—¶é€‰æ‹©æ¨¡æ¿
2. ç³»ç»Ÿæ ¹æ®æ¨¡æ¿ç”Ÿæˆæ ‡æ³¨ç•Œé¢
3. æ ‡æ³¨æ•°æ®è‡ªåŠ¨éªŒè¯
4. æ”¯æŒå®æ—¶å­—æ®µéªŒè¯

### 11. ä¸‹ä¸€æ­¥è®¡åˆ’

1. **å‰ç«¯é›†æˆ**: æ›´æ–°å‰ç«¯ä»¥æ”¯æŒæ–°çš„æ¨¡æ¿æ ¼å¼å’ŒéªŒè¯API
2. **æ¨¡æ¿ç¼–è¾‘å™¨**: å¼€å‘å¯è§†åŒ–æ¨¡æ¿ç¼–è¾‘å™¨
3. **æ¨¡æ¿å¸‚åœº**: å»ºç«‹æ¨¡æ¿åˆ†äº«å’Œä¸‹è½½æœºåˆ¶
4. **é«˜çº§éªŒè¯**: æ”¯æŒæ›´å¤æ‚çš„éªŒè¯è§„åˆ™å’Œæ¡ä»¶
5. **æ€§èƒ½ä¼˜åŒ–**: è¿›ä¸€æ­¥ä¼˜åŒ–éªŒè¯æ€§èƒ½

## æ€»ç»“

æ–°çš„æ–‡æ¡£éªŒè¯ç³»ç»Ÿæä¾›äº†ï¼š
- ğŸ¯ **ç±»å‹å®‰å…¨**: åŸºäºPydanticçš„å¼ºç±»å‹éªŒè¯
- ğŸ”§ **çµæ´»é…ç½®**: ä¸°å¯Œçš„å­—æ®µç±»å‹å’ŒéªŒè¯è§„åˆ™
- ğŸš€ **é«˜æ€§èƒ½**: ç¼“å­˜æœºåˆ¶å’Œä¼˜åŒ–çš„éªŒè¯é€»è¾‘
- ğŸ”„ **å…¼å®¹æ€§**: æ”¯æŒå¤šç‰ˆæœ¬Pydanticå’Œå‘åå…¼å®¹
- ğŸ“ **æ˜“ç”¨æ€§**: æ¸…æ™°çš„APIå’Œè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- ğŸ§ª **å¯é æ€§**: å…¨é¢çš„æµ‹è¯•è¦†ç›–

ç³»ç»Ÿå·²ç»å®Œå…¨å°±ç»ªï¼Œå¯ä»¥æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ï¼ 