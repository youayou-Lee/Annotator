# 文档验证模板指南

## 1. 概述

文档验证模板是一个Python文件，用于定义标注任务中需要标注的字段及其类型。模板文件需要遵循特定的格式规范，以便系统能够正确解析并生成标注界面。

## 2. 模板文件格式

### 2.1 基本结构

每个模板文件必须包含一个名为 `AnnotationSchema` 的类，该类包含以下内容：

1. `schema_name`: 模板名称
2. `version`: 模板版本号
3. `description`: 模板描述
4. `fields`: 需要标注的字段定义

基本结构示例：

```python
from typing import List, Dict, Any, Optional, Union
from pydantic import BaseModel, Field

class AnnotationSchema:
    schema_name = "示例标注模板"
    version = "1.0.0"
    description = "这是一个示例标注模板"
    
    class Fields(BaseModel):
        # 字段定义
        pass
    
    fields = Fields
```

### 2.2 字段定义

字段定义使用Pydantic模型，支持以下数据类型：

- `str`: 字符串
- `int`: 整数
- `float`: 浮点数
- `bool`: 布尔值
- `List`: 列表
- `Dict`: 字典
- 嵌套模型: 复杂数据结构

每个字段可以添加的元数据：

- `description`: 字段描述，会显示在标注界面
- `example`: 示例值
- `min_length/max_length`: 字符串长度限制
- `gt/ge/lt/le`: 数值大小限制
- `regex`: 正则表达式验证
- `choices`: 可选值列表（用于下拉选择）

## 3. 示例

### 3.1 简单字段示例

```python
from typing import List, Dict, Any, Optional, Union
from pydantic import BaseModel, Field

class AnnotationSchema:
    schema_name = "简单字段示例"
    version = "1.0.0"
    description = "包含基本数据类型的标注模板"
    
    class Fields(BaseModel):
        title: str = Field(
            description="文档标题",
            min_length=1,
            max_length=100,
            example="示例标题"
        )
        
        content: str = Field(
            description="文档内容",
            min_length=1,
            example="这是文档内容示例"
        )
        
        importance: int = Field(
            description="重要性评分",
            ge=1,
            le=5,
            example=3
        )
        
        is_reviewed: bool = Field(
            description="是否已审核",
            example=False
        )
    
    fields = Fields
```

### 3.2 嵌套结构示例

```python
from typing import List, Dict, Any, Optional, Union
from pydantic import BaseModel, Field
from enum import Enum

class DocumentType(str, Enum):
    ARTICLE = "article"
    REPORT = "report"
    CONTRACT = "contract"
    OTHER = "other"

class AnnotationSchema:
    schema_name = "嵌套结构示例"
    version = "1.0.0"
    description = "包含嵌套数据结构的标注模板"
    
    class Author(BaseModel):
        name: str = Field(description="作者姓名")
        email: Optional[str] = Field(description="作者邮箱", default=None)
        
    class Attachment(BaseModel):
        filename: str = Field(description="附件文件名")
        file_type: str = Field(description="附件类型")
        size: int = Field(description="附件大小(KB)", ge=0)
    
    class Fields(BaseModel):
        title: str = Field(description="文档标题")
        doc_type: DocumentType = Field(description="文档类型")
        authors: List[Author] = Field(description="作者列表")
        content: str = Field(description="文档内容")
        keywords: List[str] = Field(description="关键词")
        attachments: Optional[List[Attachment]] = Field(description="附件列表", default=[])
        metadata: Dict[str, Any] = Field(description="元数据")
    
    fields = Fields
```

### 3.3 表格数据示例

```python
from typing import List, Dict, Any, Optional, Union
from pydantic import BaseModel, Field
from enum import Enum

class CellType(str, Enum):
    TEXT = "text"
    NUMBER = "number"
    DATE = "date"

class AnnotationSchema:
    schema_name = "表格数据示例"
    version = "1.0.0"
    description = "用于表格数据标注的模板"
    
    class TableCell(BaseModel):
        value: Any = Field(description="单元格值")
        cell_type: CellType = Field(description="单元格类型")
        row: int = Field(description="行索引", ge=0)
        col: int = Field(description="列索引", ge=0)
        span_rows: int = Field(description="跨行数", ge=1, default=1)
        span_cols: int = Field(description="跨列数", ge=1, default=1)
    
    class TableRow(BaseModel):
        cells: List[TableCell] = Field(description="行数据")
        is_header: bool = Field(description="是否为表头", default=False)
    
    class Fields(BaseModel):
        table_title: str = Field(description="表格标题")
        rows: List[TableRow] = Field(description="表格行")
        notes: Optional[str] = Field(description="备注", default="")
    
    fields = Fields
```

## 4. 字段元数据

除了Pydantic自带的字段验证功能外，标注系统还支持以下扩展元数据：

### 4.1 UI控件指定

可以通过`ui_widget`属性指定特定的UI控件：

```python
class Fields(BaseModel):
    description: str = Field(
        description="详细描述",
        ui_widget="textarea",  # 使用多行文本框
        min_length=10
    )
    
    color: str = Field(
        description="颜色",
        ui_widget="color-picker"  # 使用颜色选择器
    )
    
    date: str = Field(
        description="日期",
        ui_widget="date-picker"  # 使用日期选择器
    )
```

支持的UI控件类型：
- `text`: 单行文本框（默认）
- `textarea`: 多行文本框
- `select`: 下拉选择框
- `radio`: 单选按钮组
- `checkbox`: 复选框
- `date-picker`: 日期选择器
- `time-picker`: 时间选择器
- `color-picker`: 颜色选择器
- `tag-input`: 标签输入框
- `monaco-editor`: 代码编辑器

### 4.2 下拉选项配置

对于需要从固定选项中选择的字段，可以使用`choices`属性：

```python
class Fields(BaseModel):
    category: str = Field(
        description="分类",
        choices=["新闻", "体育", "娱乐", "科技", "其他"]
    )
```

### 4.3 条件显示

可以通过`depends_on`属性实现条件显示：

```python
class Fields(BaseModel):
    has_attachment: bool = Field(description="是否有附件")
    
    attachment_name: Optional[str] = Field(
        description="附件名称",
        depends_on={"has_attachment": True}  # 只有当has_attachment为True时才显示
    )
```

## 5. 验证规则

### 5.1 基本验证

模板文件在使用前会进行基本验证，确保：

1. 文件是有效的Python文件
2. 包含`AnnotationSchema`类
3. 定义了必要的属性（schema_name, version, description, fields）
4. 所有字段都有描述信息

### 5.2 额外验证规则

1. 所有字段名应使用小驼峰命名法（例如：`documentTitle`）或下划线命名法（例如：`document_title`）
2. 所有字段应提供描述信息
3. 使用`typing`模块提供的类型而不是Python内置类型（例如：使用`List[str]`而非`list`）
4. 嵌套结构不应超过3层
5. 对于数值类型，应提供合理的范围限制

## 6. 在任务中使用模板

当创建任务时，系统会：

1. 加载并验证选定的模板文件
2. 解析字段定义和验证规则
3. 根据模板生成标注界面
4. 将标注结果根据模板进行验证

## 7. 最佳实践

1. **字段命名**: 使用明确、简洁的字段名，避免特殊字符
2. **必要说明**: 为每个字段提供清晰的描述
3. **合理分组**: 对相关字段进行分组，使用嵌套模型
4. **默认值**: 为可选字段提供合理的默认值
5. **验证规则**: 添加适当的验证规则，确保数据质量
6. **示例值**: 为关键字段提供示例值，帮助标注人员理解

## 8. 常见问题

### 8.1 模板解析失败

常见原因：
- Python语法错误
- 缺少必要的导入
- 类结构不符合规范
- 字段定义不正确

### 8.2 标注界面显示异常

可能原因：
- 嵌套层级过深
- 字段类型不受支持
- UI控件指定不正确

### 8.3 标注数据验证失败

可能原因：
- 数据类型不匹配
- 数据不符合验证规则
- 必填字段未填写
