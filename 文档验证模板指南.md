# 文档验证模板指南

## 1. 概述

文档验证模板是基于Pydantic v2的Python文件，用于定义JSON/JSONL文档的结构和标注字段。支持复杂嵌套结构，自动提取标注字段及其约束条件。

## 2. 核心概念

### 2.1 主模型标识
使用 `model_config` 标识主模型：
```python
model_config = ConfigDict(json_schema_extra={"is_main_model": True})
```

### 2.2 标注字段标记
使用 `json_schema_extra={"is_annotation": True}` 标记需要标注的字段：
```python
field_name: str = Field(..., json_schema_extra={"is_annotation": True}, description="字段描述")
```

### 2.3 路径表示法
- 基础字段：`field_name`
- 嵌套对象：`parent.child`
- 数组元素：`array_field[]`
- 深层嵌套：`parent.array[].nested.field`

## 3. 基本模板

```python
from pydantic import BaseModel, Field, ConfigDict
from typing import List, Optional

class DocumentModel(BaseModel):
    """文档主模型"""
    # 非标注字段（仅用于验证）
    id: str = Field(..., description="文档ID")
    
    # 标注字段
    title: str = Field(
        ..., 
        json_schema_extra={"is_annotation": True}, 
        min_length=5, 
        max_length=200, 
        description="文档标题"
    )
    
    content: str = Field(
        ..., 
        json_schema_extra={"is_annotation": True}, 
        description="文档内容"
    )
    
    # 标识主模型
    model_config = ConfigDict(json_schema_extra={"is_main_model": True})
```

## 4. 嵌套结构模板

```python
from pydantic import BaseModel, Field, ConfigDict
from typing import List
from enum import Enum

class SentimentType(str, Enum):
    POSITIVE = "positive"
    NEGATIVE = "negative"
    NEUTRAL = "neutral"

class EntityInfo(BaseModel):
    """实体信息"""
    name: str = Field(..., json_schema_extra={"is_annotation": True}, description="实体名称")
    type: str = Field(..., json_schema_extra={"is_annotation": True}, description="实体类型")
    confidence: float = Field(..., json_schema_extra={"is_annotation": True}, ge=0.0, le=1.0, description="置信度")

class AnnotationData(BaseModel):
    """标注数据"""
    sentiment: SentimentType = Field(..., json_schema_extra={"is_annotation": True}, description="情感倾向")
    score: float = Field(..., json_schema_extra={"is_annotation": True}, ge=-1.0, le=1.0, description="情感分数")
    entities: List[EntityInfo] = Field(..., json_schema_extra={"is_annotation": True}, description="实体列表")

class Paragraph(BaseModel):
    """段落"""
    text: str = Field(..., json_schema_extra={"is_annotation": True}, description="段落文本")
    annotations: AnnotationData = Field(..., json_schema_extra={"is_annotation": True}, description="标注数据")

class ComplexDocumentModel(BaseModel):
    """复杂文档模型"""
    document_id: str = Field(..., description="文档ID")
    title: str = Field(..., json_schema_extra={"is_annotation": True}, description="文档标题")
    paragraphs: List[Paragraph] = Field(..., json_schema_extra={"is_annotation": True}, description="段落列表")
    
    model_config = ConfigDict(json_schema_extra={"is_main_model": True})
```

## 5. 支持的类型和约束

### 5.1 基础类型
```python
# 字符串
text: str = Field(..., json_schema_extra={"is_annotation": True}, min_length=1, max_length=100)

# 数值
count: int = Field(..., json_schema_extra={"is_annotation": True}, ge=0, le=100)
score: float = Field(..., json_schema_extra={"is_annotation": True}, ge=0.0, le=1.0)

# 布尔值
is_valid: bool = Field(..., json_schema_extra={"is_annotation": True})

# 列表
tags: List[str] = Field(..., json_schema_extra={"is_annotation": True})

# 可选字段
optional_field: Optional[str] = Field(None, json_schema_extra={"is_annotation": True})
```

### 5.2 约束条件
- **数值约束**：`ge`（≥）、`le`（≤）、`gt`（>）、`lt`（<）
- **字符串约束**：`min_length`、`max_length`、`pattern`（正则）
- **列表约束**：`min_length`、`max_length`

## 6. 高级特性

### 6.1 多模型文件
```python
# 辅助模型
class HelperModel(BaseModel):
    helper_field: str = Field(..., description="辅助字段")

# 主模型
class MainDocumentModel(BaseModel):
    main_field: str = Field(..., json_schema_extra={"is_annotation": True}, description="主要字段")
    helper: HelperModel = Field(..., description="辅助对象")
    
    model_config = ConfigDict(json_schema_extra={"is_main_model": True})
```

### 6.2 深层嵌套
```python
class Level3Model(BaseModel):
    deep_field: str = Field(..., json_schema_extra={"is_annotation": True}, description="深层字段")

class Level2Model(BaseModel):
    level3_items: List[Level3Model] = Field(..., json_schema_extra={"is_annotation": True})

class Level1Model(BaseModel):
    level2: Level2Model = Field(..., json_schema_extra={"is_annotation": True})

class DeepNestedModel(BaseModel):
    level1_array: List[Level1Model] = Field(..., json_schema_extra={"is_annotation": True})
    model_config = ConfigDict(json_schema_extra={"is_main_model": True})
```
提取路径：`level1_array[].level2.level3_items[].deep_field`

## 7. 最佳实践

1. **明确主模型**：确保只有一个模型标记为 `is_main_model: True`
2. **合理标注粒度**：只标记真正需要人工标注的字段
3. **添加详细描述**：为每个标注字段提供清晰的描述信息
4. **使用约束条件**：利用约束确保数据质量
5. **避免过度嵌套**：保持结构清晰，避免不必要的复杂性

### 7.1 约束设计示例
```python
# 推荐：字符串长度限制
title: str = Field(
    ..., 
    json_schema_extra={"is_annotation": True}, 
    min_length=1, max_length=200,
    description="文档标题"
)
```

## 8. 常见问题

### 8.1 主模型识别问题
**问题**：Multiple main models found 或 No main BaseModel found
**解决**：确保只有一个模型标记为主模型

### 8.2 字段未被提取
**问题**：定义的字段没有出现在标注字段列表中
**解决**：检查是否添加了 `json_schema_extra={"is_annotation": True}` 标记

### 8.3 约束条件无效
**问题**：设置的约束条件没有生效
**解决**：确保使用正确的Pydantic v2约束语法

## 9. 系统要求

- Python 3.8+
- Pydantic v2.0+

## 10. 参考示例

完整示例文件：
- `document_validator/complex_template.py` - 复杂嵌套结构示例
- `document_validator/complex_sample.json` - 对应的JSON数据示例
